<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR-SoM</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { 
            height: 100%; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #fff;
        }
        input[type="file"] { display: none; }
        .hidden { display: none !important; }
        
        /* ===== é¦–é¡µ ===== */
        .home {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .home-title {
            font-size: 48px;
            font-weight: 300;
            color: #222;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }
        .home-subtitle {
            font-size: 15px;
            color: #999;
            margin-bottom: 48px;
        }
        .home-btn {
            background: #222;
            color: #fff;
            border: none;
            padding: 16px 48px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .home-btn:hover { background: #444; transform: scale(1.02); }
        .home-hint {
            margin-top: 16px;
            font-size: 13px;
            color: #bbb;
        }
        .home-device {
            position: absolute;
            bottom: 24px;
            font-size: 12px;
            color: #ccc;
        }
        
        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            background: #f5f5f5;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: #666;
        }
        .settings-btn:hover { background: #eee; }
        
        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100%;
            background: #fff;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            z-index: 100;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .settings-panel.open { right: 0; }
        .settings-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .settings-title { font-size: 16px; font-weight: 600; }
        .settings-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .settings-close:hover { color: #333; }
        .settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .settings-section {
            margin-bottom: 24px;
        }
        .settings-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        .settings-item {
            margin-bottom: 16px;
        }
        .settings-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .settings-label-text { font-size: 14px; color: #333; }
        .settings-label-value { font-size: 12px; color: #999; font-family: monospace; }
        .settings-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .settings-input:focus { border-color: #666; outline: none; }
        .settings-range {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #eee;
            border-radius: 3px;
            outline: none;
        }
        .settings-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #333;
            border-radius: 50%;
            cursor: pointer;
        }
        .settings-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .settings-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .settings-footer {
            padding: 16px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 12px;
        }
        .settings-footer-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        .settings-footer-btn.primary {
            background: #222;
            color: #fff;
        }
        .settings-footer-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .settings-overlay.open { opacity: 1; visibility: visible; }
        
        /* ===== åŠ è½½é¡µ ===== */
        .loading-page {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid #eee;
            border-top-color: #222;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #666; font-size: 15px; }
        
        /* ===== ç»“æœé¡µ ===== */
        .result-page {
            height: 100%;
            display: flex;
        }
        
        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            width: 380px;
            min-width: 380px;
            height: 100%;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            background: #fff;
        }
        .panel-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .panel-title { font-size: 15px; font-weight: 600; color: #333; }
        .panel-stats { font-size: 12px; color: #999; }
        .panel-btn {
            background: #f5f5f5;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }
        .panel-btn:hover { background: #eee; }
        
        /* æœç´¢æ¡† */
        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 6px;
            padding: 0 12px;
        }
        .search-icon { color: #999; font-size: 14px; margin-right: 8px; }
        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 0;
            font-size: 14px;
            outline: none;
        }
        .search-input::placeholder { color: #bbb; }
        .search-clear {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }
        .search-clear:hover { color: #666; }
        
        .element-list {
            flex: 1;
            overflow-y: auto;
        }
        .element-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .element-item:hover { background: #f0f0f0; }
        .element-item.active { background: #e8f4ff; }
        .element-item.hidden-by-search { display: none; }
        .element-id {
            background: #222;
            color: #fff;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            min-width: 28px;
            text-align: center;
        }
        .element-item.active .element-id { background: #0066cc; }
        .element-info { flex: 1; min-width: 0; }
        .element-text {
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .element-meta {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
            font-family: monospace;
        }
        
        /* æœç´¢é«˜äº® */
        .highlight-text { background: #fff3cd; padding: 1px 2px; border-radius: 2px; }
        
        /* æ— æœç´¢ç»“æœ */
        .no-results {
            padding: 40px 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
        
        /* å³ä¾§å›¾ç‰‡æŸ¥çœ‹å™¨ */
        .right-panel {
            flex: 1;
            height: 100%;
            background: #1a1a1a;
            position: relative;
            overflow: hidden;
        }
        .viewer-toolbar {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .viewer-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .viewer-btn:hover { background: #fff; transform: scale(1.05); }
        
        .viewer-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            position: relative;
        }
        .viewer-container:active { cursor: grabbing; }
        
        .viewer-canvas {
            position: relative;
            transform-origin: center center;
        }
        .viewer-img {
            display: block;
            max-width: none;
            user-select: none;
            -webkit-user-drag: none;
            pointer-events: none;
            border-radius: 4px;
        }
        
        /* èšå…‰ç¯é®ç½© - ç”¨ SVG å®ç°é•‚ç©ºæ•ˆæœ */
        .spotlight-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .spotlight-overlay.active { opacity: 1; }
        
        /* èšå…‰ç¯é•‚ç©ºåŠ¨ç”» - ä»å…¨å±ç¼©å°åˆ°ç›®æ ‡ */
        #spotlightHole {
            transition: x 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        y 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* é«˜äº®æ¡†è¾¹æ¡† */
        .highlight-box {
            position: absolute;
            border: 3px solid #00ff88;
            border-radius: 4px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.8), 0 0 40px rgba(0, 255, 136, 0.4);
            opacity: 0;
            transition: all 0.3s;
        }
        .highlight-box.active { 
            opacity: 1;
            animation: pulse-glow 1.5s ease-in-out;
        }
        
        /* è„‰å†²åŠ¨ç”» */
        @keyframes pulse-glow {
            0% { 
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.8), 0 0 40px rgba(0, 255, 136, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(0, 255, 136, 1), 0 0 80px rgba(0, 255, 136, 0.6);
                transform: scale(1.02);
            }
            100% { 
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.8), 0 0 40px rgba(0, 255, 136, 0.4);
                transform: scale(1);
            }
        }
        
        /* å¼•å¯¼ç®­å¤´åŠ¨ç”» */
        .guide-arrow {
            position: absolute;
            width: 30px;
            height: 30px;
            pointer-events: none;
            z-index: 15;
            opacity: 0;
        }
        .guide-arrow.active {
            animation: arrow-guide 0.6s ease-out forwards;
        }
        @keyframes arrow-guide {
            0% { opacity: 1; transform: translate(-50px, -50px) scale(1.5); }
            100% { opacity: 0; transform: translate(0, 0) scale(1); }
        }
        
        /* ç¼©æ”¾æç¤º */
        .zoom-indicator {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span class="settings-title">å‚æ•°è®¾ç½®</span>
            <button class="settings-close" id="settingsClose">Ã—</button>
        </div>
        <div class="settings-body">
            <div class="settings-section">
                <div class="settings-section-title">è¯†åˆ«æ¨¡å¼</div>
                <div class="settings-item">
                    <label class="settings-checkbox">
                        <input type="checkbox" id="optOcrOnly">
                        <span>ä»… OCRï¼ˆä¸æ£€æµ‹è½®å»“ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰</span>
                    </label>
                </div>
                <div class="settings-item">
                    <label class="settings-checkbox">
                        <input type="checkbox" id="optDetectContours" checked>
                        <span>æ£€æµ‹ UI è½®å»“ï¼ˆå›¾æ ‡ã€æŒ‰é’®ç­‰ï¼‰</span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section" id="contourSettings">
                <div class="settings-section-title">è½®å»“æ£€æµ‹å‚æ•°</div>
                <div style="font-size: 12px; color: #888; margin-bottom: 12px; padding: 8px; background: #f8f8f8; border-radius: 4px;">
                    ğŸ’¡ è¿™äº›å‚æ•°åªå½±å“çº¢æ¡†ï¼ˆUIè½®å»“ï¼‰ï¼Œä¸å½±å“è“æ¡†ï¼ˆOCRæ–‡å­—ï¼‰ã€‚ä¿®æ”¹åéœ€é‡æ–°ä¸Šä¼ å›¾ç‰‡ã€‚
                </div>
                <div class="settings-item">
                    <div class="settings-label">
                        <span class="settings-label-text">æœ€å°é¢ç§¯</span>
                        <span class="settings-label-value" id="valMinArea">200</span>
                    </div>
                    <input type="range" class="settings-range" id="optMinArea" min="50" max="2000" value="200">
                    <div style="font-size: 11px; color: #999; margin-top: 2px;">è°ƒå° â†’ æ£€æµ‹æ›´å¤šå°å›¾æ ‡ï¼›è°ƒå¤§ â†’ è¿‡æ»¤å™ªç‚¹</div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">
                        <span class="settings-label-text">æœ€å¤§é¢ç§¯</span>
                        <span class="settings-label-value" id="valMaxArea">80000</span>
                    </div>
                    <input type="range" class="settings-range" id="optMaxArea" min="10000" max="200000" value="80000">
                    <div style="font-size: 11px; color: #999; margin-top: 2px;">è°ƒå° â†’ è¿‡æ»¤å¤§è‰²å—ï¼›è°ƒå¤§ â†’ æ£€æµ‹å¤§åŒºåŸŸ</div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">
                        <span class="settings-label-text">æœ€å°å°ºå¯¸</span>
                        <span class="settings-label-value" id="valMinSize">16</span>
                    </div>
                    <input type="range" class="settings-range" id="optMinSize" min="8" max="50" value="16">
                    <div style="font-size: 11px; color: #999; margin-top: 2px;">å®½/é«˜çš„æœ€å°åƒç´ å€¼</div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">
                        <span class="settings-label-text">å¡«å……ç‡é˜ˆå€¼</span>
                        <span class="settings-label-value" id="valFillRatio">0.3</span>
                    </div>
                    <input type="range" class="settings-range" id="optFillRatio" min="0.1" max="0.9" step="0.05" value="0.3">
                    <div style="font-size: 11px; color: #999; margin-top: 2px;">è°ƒå° â†’ ä¹Ÿæ£€æµ‹ç©ºå¿ƒæ¡†ï¼›è°ƒå¤§ â†’ åªæ£€æµ‹å®å¿ƒåŒºåŸŸ</div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">
                        <span class="settings-label-text">é¥±å’Œåº¦é˜ˆå€¼</span>
                        <span class="settings-label-value" id="valSaturation">40</span>
                    </div>
                    <input type="range" class="settings-range" id="optSaturation" min="0" max="100" value="40">
                    <div style="font-size: 11px; color: #999; margin-top: 2px;">è°ƒå° â†’ ä¹Ÿæ£€æµ‹ç°è‰²å…ƒç´ ï¼›è®¾ä¸º0 â†’ ç¦ç”¨å½©è‰²æ£€æµ‹</div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">é¢„è®¾</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="settings-footer-btn secondary" onclick="applyPreset('default')">é»˜è®¤</button>
                    <button class="settings-footer-btn secondary" onclick="applyPreset('fast')">å¿«é€Ÿ</button>
                    <button class="settings-footer-btn secondary" onclick="applyPreset('detailed')">è¯¦ç»†</button>
                    <button class="settings-footer-btn secondary" onclick="applyPreset('ocrOnly')">çº¯ OCR</button>
                </div>
            </div>
        </div>
        <div class="settings-footer">
            <button class="settings-footer-btn secondary" id="settingsReset">é‡ç½®é»˜è®¤</button>
            <button class="settings-footer-btn primary" id="settingsApply">åº”ç”¨</button>
        </div>
    </div>
    
    <!-- é¦–é¡µ -->
    <div class="home" id="homePage">
        <h1 class="home-title">OCR-SoM</h1>
        <p class="home-subtitle">åŸºäº PaddleOCR çš„è§†è§‰æ ‡æ³¨å·¥å…·</p>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button class="home-btn" id="uploadBtn">é€‰æ‹©å›¾ç‰‡</button>
            <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
        </div>
        <p class="home-hint">æ”¯æŒæ‹–æ‹½ä¸Šä¼  PNGã€JPGã€GIF</p>
        <div class="home-device" id="deviceInfo"></div>
    </div>
    <input type="file" id="fileInput" accept="image/*">
    
    <!-- åŠ è½½é¡µ -->
    <div class="loading-page hidden" id="loadingPage">
        <div class="spinner"></div>
        <div class="loading-text">æ­£åœ¨è¯†åˆ«...</div>
    </div>
    
    <!-- ç»“æœé¡µ -->
    <div class="result-page hidden" id="resultPage">
        <div class="left-panel">
            <div class="panel-header">
                <div class="panel-top">
                    <div>
                        <div class="panel-title">è¯†åˆ«ç»“æœ</div>
                        <div class="panel-stats" id="stats"></div>
                    </div>
                    <button class="panel-btn" id="downloadBtn">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
                    <button class="panel-btn" id="settingsBtn2">âš™ï¸ è®¾ç½®</button>
                    <button class="panel-btn" id="newUploadBtn">é‡æ–°ä¸Šä¼ </button>
                </div>
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ–‡å­—...">
                    <button class="search-clear hidden" id="searchClear">Ã—</button>
                </div>
            </div>
            <div class="element-list" id="elementList"></div>
            <div class="no-results hidden" id="noResults">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>
        </div>
        <div class="right-panel">
            <div class="viewer-toolbar">
                <button class="viewer-btn" id="zoomInBtn" title="æ”¾å¤§">+</button>
                <button class="viewer-btn" id="zoomOutBtn" title="ç¼©å°">âˆ’</button>
                <button class="viewer-btn" id="resetBtn" title="é‡ç½®">â†º</button>
            </div>
            <div class="viewer-container" id="viewerContainer">
                <svg class="spotlight-overlay" id="spotlightOverlay">
                    <defs>
                        <mask id="spotlightMask">
                            <rect width="100%" height="100%" fill="white"/>
                            <rect id="spotlightHole" fill="black" rx="4"/>
                        </mask>
                    </defs>
                    <rect width="100%" height="100%" fill="rgba(0,0,0,0.75)" mask="url(#spotlightMask)"/>
                </svg>
                <div class="viewer-canvas" id="viewerCanvas">
                    <img class="viewer-img" id="resultImg" draggable="false">
                    <div class="highlight-box" id="highlightBox"></div>
                    <div class="guide-arrow" id="guideArrow">
                        <svg viewBox="0 0 30 30" fill="none">
                            <path d="M5 25 L25 5 M25 5 L15 5 M25 5 L25 15" stroke="#00ff88" stroke-width="3" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="zoom-indicator" id="zoomIndicator">100%</div>
        </div>
    </div>
    
    <script>
        // å…ƒç´ å¼•ç”¨
        const homePage = document.getElementById('homePage');
        const loadingPage = document.getElementById('loadingPage');
        const resultPage = document.getElementById('resultPage');
        const uploadBtn = document.getElementById('uploadBtn');
        const newUploadBtn = document.getElementById('newUploadBtn');
        const fileInput = document.getElementById('fileInput');
        const deviceInfo = document.getElementById('deviceInfo');
        const stats = document.getElementById('stats');
        const elementList = document.getElementById('elementList');
        const resultImg = document.getElementById('resultImg');
        const viewerContainer = document.getElementById('viewerContainer');
        const viewerCanvas = document.getElementById('viewerCanvas');
        const highlightBox = document.getElementById('highlightBox');
        const spotlightOverlay = document.getElementById('spotlightOverlay');
        const spotlightHole = document.getElementById('spotlightHole');
        const guideArrow = document.getElementById('guideArrow');
        const zoomIndicator = document.getElementById('zoomIndicator');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetBtn = document.getElementById('resetBtn');
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');
        const noResults = document.getElementById('noResults');
        
        // çŠ¶æ€
        let currentElements = [];
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let startX, startY;
        let imgNaturalWidth = 0;
        let imgNaturalHeight = 0;
        let focusTimeout = null;
        
        // è®¾ç½®é€‰é¡¹ï¼ˆä» localStorage è¯»å–ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
        const defaultSettings = {
            ocr_only: false,
            detect_contours: true,
            min_area: 200,
            max_area: 80000,
            min_size: 16,
            fill_ratio: 0.3,
            saturation_threshold: 40,
        };
        let settings = { ...defaultSettings };
        try {
            const saved = localStorage.getItem('ocr-som-settings');
            if (saved) settings = { ...defaultSettings, ...JSON.parse(saved) };
        } catch (e) {}
        
        function saveSettings() {
            try {
                localStorage.setItem('ocr-som-settings', JSON.stringify(settings));
            } catch (e) {}
        }
        
        // è®¾ç½®å…ƒç´ 
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const settingsClose = document.getElementById('settingsClose');
        const settingsReset = document.getElementById('settingsReset');
        const settingsApply = document.getElementById('settingsApply');
        
        // è®¾ç½®é¢æ¿å¼€å…³
        function openSettings() {
            settingsPanel.classList.add('open');
            settingsOverlay.classList.add('open');
        }
        function closeSettings() {
            settingsPanel.classList.remove('open');
            settingsOverlay.classList.remove('open');
        }
        settingsBtn.addEventListener('click', openSettings);
        document.getElementById('settingsBtn2').addEventListener('click', openSettings);
        settingsClose.addEventListener('click', closeSettings);
        settingsOverlay.addEventListener('click', closeSettings);
        
        // è®¾ç½®æ»‘å—å€¼æ˜¾ç¤º
        const rangeInputs = [
            { id: 'optMinArea', valId: 'valMinArea', key: 'min_area' },
            { id: 'optMaxArea', valId: 'valMaxArea', key: 'max_area' },
            { id: 'optMinSize', valId: 'valMinSize', key: 'min_size' },
            { id: 'optFillRatio', valId: 'valFillRatio', key: 'fill_ratio' },
            { id: 'optSaturation', valId: 'valSaturation', key: 'saturation_threshold' },
        ];
        
        rangeInputs.forEach(({ id, valId, key }) => {
            const input = document.getElementById(id);
            const valEl = document.getElementById(valId);
            input.addEventListener('input', () => {
                valEl.textContent = input.value;
                settings[key] = parseFloat(input.value);
            });
        });
        
        // OCR Only å’Œ è½®å»“æ£€æµ‹äº’æ–¥
        const optOcrOnly = document.getElementById('optOcrOnly');
        const optDetectContours = document.getElementById('optDetectContours');
        const contourSettings = document.getElementById('contourSettings');
        
        optOcrOnly.addEventListener('change', () => {
            settings.ocr_only = optOcrOnly.checked;
            if (optOcrOnly.checked) {
                optDetectContours.checked = false;
                settings.detect_contours = false;
                contourSettings.style.opacity = '0.5';
                contourSettings.style.pointerEvents = 'none';
            }
        });
        
        optDetectContours.addEventListener('change', () => {
            settings.detect_contours = optDetectContours.checked;
            if (optDetectContours.checked) {
                optOcrOnly.checked = false;
                settings.ocr_only = false;
                contourSettings.style.opacity = '1';
                contourSettings.style.pointerEvents = 'auto';
            } else {
                contourSettings.style.opacity = '0.5';
                contourSettings.style.pointerEvents = 'none';
            }
        });
        
        // é¢„è®¾
        function applyPreset(preset, save = true) {
            const presets = {
                default: { ocr_only: false, detect_contours: true, min_area: 200, max_area: 80000, min_size: 16, fill_ratio: 0.3, saturation_threshold: 40 },
                fast: { ocr_only: true, detect_contours: false, min_area: 200, max_area: 80000, min_size: 16, fill_ratio: 0.3, saturation_threshold: 40 },
                detailed: { ocr_only: false, detect_contours: true, min_area: 100, max_area: 150000, min_size: 12, fill_ratio: 0.2, saturation_threshold: 30 },
                ocrOnly: { ocr_only: true, detect_contours: false, min_area: 200, max_area: 80000, min_size: 16, fill_ratio: 0.3, saturation_threshold: 40 },
            };
            settings = { ...presets[preset] };
            updateSettingsUI();
            if (save) saveSettings();  // é¢„è®¾ä¹Ÿä¿å­˜
        }
        
        function updateSettingsUI() {
            optOcrOnly.checked = settings.ocr_only;
            optDetectContours.checked = settings.detect_contours;
            document.getElementById('optMinArea').value = settings.min_area;
            document.getElementById('valMinArea').textContent = settings.min_area;
            document.getElementById('optMaxArea').value = settings.max_area;
            document.getElementById('valMaxArea').textContent = settings.max_area;
            document.getElementById('optMinSize').value = settings.min_size;
            document.getElementById('valMinSize').textContent = settings.min_size;
            document.getElementById('optFillRatio').value = settings.fill_ratio;
            document.getElementById('valFillRatio').textContent = settings.fill_ratio;
            document.getElementById('optSaturation').value = settings.saturation_threshold;
            document.getElementById('valSaturation').textContent = settings.saturation_threshold;
            
            contourSettings.style.opacity = settings.detect_contours ? '1' : '0.5';
            contourSettings.style.pointerEvents = settings.detect_contours ? 'auto' : 'none';
        }
        
        settingsReset.addEventListener('click', () => applyPreset('default'));
        settingsApply.addEventListener('click', () => {
            saveSettings();  // ä¿å­˜åˆ° localStorage
            closeSettings();
            // å¦‚æœå·²æœ‰ç»“æœï¼Œæç¤ºé‡æ–°ä¸Šä¼ 
            if (!resultPage.classList.contains('hidden')) {
                alert('è®¾ç½®å·²ä¿å­˜ï¼Œé‡æ–°ä¸Šä¼ å›¾ç‰‡åç”Ÿæ•ˆ');
            }
        });
        
        // åˆå§‹åŒ–ï¼šä» localStorage æ¢å¤è®¾ç½®
        updateSettingsUI();
        
        // è·å–è®¾å¤‡ä¿¡æ¯
        fetch('/info').then(r => r.json()).then(data => {
            deviceInfo.textContent = `è¿è¡Œäº ${data.device}`;
        });
        
        // ä¸Šä¼ æŒ‰é’®
        uploadBtn.addEventListener('click', () => {
            fileInput.value = '';  // æ¸…ç©ºï¼Œå…è®¸é€‰æ‹©åŒä¸€æ–‡ä»¶
            fileInput.click();
        });
        newUploadBtn.addEventListener('click', () => {
            fileInput.value = '';
            fileInput.click();
        });
        
        // ä¸‹è½½æ ‡æ³¨å›¾
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const img = document.getElementById('resultImg');
            if (!img.src) return;
            
            const link = document.createElement('a');
            link.download = 'ocr-som-' + Date.now() + '.png';
            link.href = img.src;
            link.click();
        });
        
        // é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ‹–æ‹½è¡Œä¸ºï¼ˆé˜²æ­¢åˆ·æ–°é¡µé¢ï¼‰
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            window.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        
        // æ‹–æ‹½ä¸Šä¼ è§†è§‰åé¦ˆ
        document.body.addEventListener('dragover', () => {
            if (!resultPage.classList.contains('hidden')) return;
            homePage.style.background = '#f8f8f8';
        });
        document.body.addEventListener('dragleave', () => {
            homePage.style.background = '';
        });
        document.body.addEventListener('drop', e => {
            homePage.style.background = '';
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        
        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) handleFile(fileInput.files[0]);
        });
        
        // æœç´¢åŠŸèƒ½
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();
            searchClear.classList.toggle('hidden', !query);
            
            let visibleCount = 0;
            elementList.querySelectorAll('.element-item').forEach(item => {
                const text = item.querySelector('.element-text').textContent.toLowerCase();
                const match = !query || text.includes(query);
                item.classList.toggle('hidden-by-search', !match);
                if (match) visibleCount++;
                
                // é«˜äº®åŒ¹é…æ–‡å­—
                const textEl = item.querySelector('.element-text');
                const originalText = item.dataset.originalText || textEl.textContent;
                item.dataset.originalText = originalText;
                
                if (query && match) {
                    const regex = new RegExp(`(${query})`, 'gi');
                    textEl.innerHTML = originalText.replace(regex, '<span class="highlight-text">$1</span>');
                } else {
                    textEl.textContent = originalText;
                }
            });
            
            noResults.classList.toggle('hidden', visibleCount > 0);
        });
        
        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
            searchInput.focus();
        });
        
        // å¤„ç†æ–‡ä»¶
        async function handleFile(file) {
            if (!file.type.startsWith('image/')) return;
            
            showPage('loading');
            searchInput.value = '';
            
            try {
                const base64 = await fileToBase64(file);
                const response = await fetch('/som', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: base64, 
                        return_image: true,
                        ocr_only: settings.ocr_only,
                        detect_contours: settings.detect_contours,
                        min_area: settings.min_area,
                        max_area: settings.max_area,
                        min_size: settings.min_size,
                        fill_ratio: settings.fill_ratio,
                        saturation_threshold: settings.saturation_threshold,
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showResult(data);
                } else {
                    alert(data.error || 'è¯†åˆ«å¤±è´¥');
                    showPage('home');
                }
            } catch (err) {
                alert('è¯·æ±‚å¤±è´¥: ' + err.message);
                showPage('home');
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function showPage(page) {
            homePage.classList.toggle('hidden', page !== 'home');
            loadingPage.classList.toggle('hidden', page !== 'loading');
            resultPage.classList.toggle('hidden', page !== 'result');
        }
        
        function showResult(data) {
            currentElements = data.elements;
            
            // æ˜¾ç¤ºå›¾ç‰‡
            resultImg.src = 'data:image/png;base64,' + data.marked_image;
            resultImg.onload = () => {
                imgNaturalWidth = resultImg.naturalWidth;
                imgNaturalHeight = resultImg.naturalHeight;
                fitToScreen();
            };
            
            // ç»Ÿè®¡
            const textCount = data.elements.filter(e => e.type === 'text').length;
            stats.textContent = `${data.count} ä¸ªå…ƒç´ ï¼Œ${textCount} ä¸ªæ–‡å­—`;
            
            // å…ƒç´ åˆ—è¡¨
            elementList.innerHTML = data.elements.map((el, idx) => `
                <div class="element-item" data-idx="${idx}" data-box="${el.box.join(',')}">
                    <span class="element-id">${el.id}</span>
                    <div class="element-info">
                        <div class="element-text">${el.text || '[UI å…ƒç´ ]'}</div>
                        <div class="element-meta">[${el.box.join(', ')}]</div>
                    </div>
                </div>
            `).join('');
            
            // ç‚¹å‡»å…ƒç´ é«˜äº®
            elementList.querySelectorAll('.element-item').forEach(item => {
                item.addEventListener('click', () => {
                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    elementList.querySelectorAll('.element-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // æ˜¾ç¤ºé«˜äº®æ¡†
                    const box = item.dataset.box.split(',').map(Number);
                    showHighlight(box);
                });
            });
            
            noResults.classList.add('hidden');
            showPage('result');
        }
        
        function showHighlight(box) {
            const [x1, y1, x2, y2] = box;
            const displayWidth = resultImg.width;
            const displayHeight = resultImg.height;
            const scaleRatio = displayWidth / imgNaturalWidth;
            
            // è®¡ç®—é«˜äº®åŒºåŸŸä½ç½®
            const hx = x1 * scaleRatio;
            const hy = y1 * scaleRatio;
            const hw = (x2 - x1) * scaleRatio;
            const hh = (y2 - y1) * scaleRatio;
            
            // é«˜äº®æ¡†
            highlightBox.style.left = hx + 'px';
            highlightBox.style.top = hy + 'px';
            highlightBox.style.width = hw + 'px';
            highlightBox.style.height = hh + 'px';
            
            // èšå…‰ç¯é®ç½©ï¼ˆSVG é•‚ç©ºæ•ˆæœï¼‰
            // éœ€è¦è€ƒè™‘ canvas çš„ transform
            const canvasRect = viewerCanvas.getBoundingClientRect();
            const containerRect = viewerContainer.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerHeight = containerRect.height;
            const offsetX = canvasRect.left - containerRect.left;
            const offsetY = canvasRect.top - containerRect.top;
            
            // ç›®æ ‡ä½ç½®
            const targetX = offsetX + hx * scale;
            const targetY = offsetY + hy * scale;
            const targetW = hw * scale;
            const targetH = hh * scale;
            
            // å¼•å¯¼ç®­å¤´
            guideArrow.style.left = hx + 'px';
            guideArrow.style.top = hy + 'px';
            
            // è§¦å‘åŠ¨ç”»
            highlightBox.classList.remove('active');
            guideArrow.classList.remove('active');
            spotlightOverlay.classList.remove('active');
            
            // 1. å…ˆç¦ç”¨ transitionï¼Œç¬é—´è®¾ç½®ä¸ºå…¨å±ï¼ˆé•‚ç©ºè¦†ç›–æ•´ä¸ªå®¹å™¨ = å…¨äº®ï¼‰
            spotlightHole.style.transition = 'none';
            spotlightHole.setAttribute('x', -50);
            spotlightHole.setAttribute('y', -50);
            spotlightHole.setAttribute('width', containerWidth + 100);
            spotlightHole.setAttribute('height', containerHeight + 100);
            
            // å¼ºåˆ¶é‡ç»˜
            void spotlightHole.getBBox();
            
            // 2. æ˜¾ç¤ºé®ç½©å±‚
            spotlightOverlay.classList.add('active');
            highlightBox.classList.add('active');
            
            // 3. æ¢å¤ transitionï¼ŒåŠ¨ç”»ç¼©å°åˆ°ç›®æ ‡ä½ç½®
            requestAnimationFrame(() => {
                spotlightHole.style.transition = '';
                spotlightHole.setAttribute('x', targetX);
                spotlightHole.setAttribute('y', targetY);
                spotlightHole.setAttribute('width', targetW);
                spotlightHole.setAttribute('height', targetH);
                
                // ç®­å¤´å»¶è¿Ÿæ˜¾ç¤º
                setTimeout(() => guideArrow.classList.add('active'), 200);
            });
            
            // 2ç§’åé®ç½©æ¶ˆå¤±
            clearTimeout(focusTimeout);
            focusTimeout = setTimeout(() => {
                spotlightOverlay.classList.remove('active');
            }, 2500);
        }
        
        // é€‚åº”å±å¹•
        function fitToScreen() {
            const containerRect = viewerContainer.getBoundingClientRect();
            const padding = 40;
            const maxWidth = containerRect.width - padding * 2;
            const maxHeight = containerRect.height - padding * 2;
            
            const widthRatio = maxWidth / imgNaturalWidth;
            const heightRatio = maxHeight / imgNaturalHeight;
            scale = Math.min(widthRatio, heightRatio, 1);
            
            translateX = 0;
            translateY = 0;
            updateTransform();
        }
        
        // ç¼©æ”¾æ§åˆ¶
        function updateTransform() {
            viewerCanvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            zoomIndicator.textContent = Math.round(scale * 100) + '%';
        }
        
        function resetView() {
            fitToScreen();
            highlightBox.classList.remove('active');
            spotlightOverlay.classList.remove('active');
            guideArrow.classList.remove('active');
            elementList.querySelectorAll('.element-item').forEach(i => i.classList.remove('active'));
        }
        
        zoomInBtn.addEventListener('click', () => {
            scale = Math.min(scale * 1.25, 5);
            updateTransform();
        });
        
        zoomOutBtn.addEventListener('click', () => {
            scale = Math.max(scale / 1.25, 0.1);
            updateTransform();
        });
        
        resetBtn.addEventListener('click', resetView);
        
        // æ»šè½®ç¼©æ”¾
        viewerContainer.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale = Math.max(0.1, Math.min(5, scale * delta));
            updateTransform();
        });
        
        // æ‹–åŠ¨
        viewerContainer.addEventListener('mousedown', e => {
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
        });
        
        document.addEventListener('mousemove', e => {
            if (!isDragging) return;
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform();
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
    </script>
</body>
</html>
